<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineSemantic - Trouvez votre prochain film</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #e50914;
            --dark: #141414;
            --light: #f5f5f1;
            --gray: #808080;
        }

        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: var(--dark);
            color: white;
            margin: 0;
            padding: 0;
        }

        .app-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            min-height: 100vh;
        }

        .sidebar {
            background-color: #000;
            padding: 30px;
            border-right: 1px solid #333;
            overflow-y: auto;
            position: sticky;
            top: 0;
            height: 100vh;
            box-sizing: border-box;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-section {
            margin-bottom: 25px;
        }

        .filter-section h3 {
            font-size: 14px;
            text-transform: uppercase;
            color: var(--gray);
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
        }

        select,
        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 10px;
            background: #333;
            border: 1px solid #444;
            border-radius: 4px;
            color: white;
            margin-bottom: 5px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 13px;
        }

        .checkbox-label input {
            margin-right: 8px;
            accent-color: var(--primary);
        }

        .genre-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .main-content {
            padding: 40px;
            background: #181818;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .movie-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 30px;
        }

        .movie-card {
            background: #2f2f2f;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.3s;
            position: relative;
            cursor: pointer;
        }

        .movie-card:hover {
            transform: scale(1.03);
            z-index: 2;
        }

        .card-image {
            height: 200px;
            background: #222;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .card-rating {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 4px 8px;
            border-radius: 4px;
            color: #46d369;
            font-weight: bold;
        }

        .card-content {
            padding: 15px;
        }

        .card-title {
            font-size: 16px;
            font-weight: bold;
            margin: 0 0 10px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-meta {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }

        .card-genres {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 12px;
        }

        .genre-pill {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            background: #444;
            color: #ddd;
        }

        .card-people {
            font-size: 12px;
            color: #ccc;
            border-top: 1px solid #444;
            padding-top: 10px;
        }

        #sparql-container {
            background: #282a36;
            color: #f8f8f2;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid #bd93f9;
            display: none;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }

        #debug-filters {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="logo"><i class="fas fa-project-diagram"></i> CineSemantic</div>

            <div class="filter-section">
                <h3><i class="fas fa-search"></i> Recherche</h3>
                <input type="text" id="f-search" placeholder="Titre..." oninput="debouncedFilterMovies()">
            </div>

            <div class="filter-section">
                <h3><i class="fas fa-film"></i> Genres</h3>
                <div class="genre-grid" id="genre-container"></div>
            </div>

            <div class="filter-section">
                <h3><i class="fas fa-star"></i> Note: <span id="rating-val" style="color:var(--primary)">0+</span></h3>
                <input type="range" id="f-rating" min="0" max="10" step="0.5" value="0" style="width:100%"
                    oninput="updateRatingDisplay(this.value); debouncedFilterMovies()">
            </div>

            <div class="filter-section">
                <h3>Année</h3>
                <div style="display:flex; gap:10px;">
                    <select id="f-year-min" onchange="filterMovies()"></select>
                    <select id="f-year-max" onchange="filterMovies()"></select>
                </div>
            </div>

            <div class="filter-section">
                <h3>Équipe</h3>
                <input type="text" id="f-director" placeholder="Réalisateur" oninput="debouncedFilterMovies()">
                <input type="text" id="f-actor" placeholder="Acteur" oninput="debouncedFilterMovies()">
            </div>

            <button onclick="resetFilters()"
                style="background:transparent; border:1px solid #666; color:white; padding:8px 15px; width:100%; cursor:pointer;">Réinitialiser</button>
            <button onclick="toggleSparql()"
                style="background:#333; color:#aaa; border:1px dashed #666; padding:8px 15px; width:100%; margin-top:10px; cursor:pointer;">Voir
                SPARQL</button>
        </aside>

        <main class="main-content">
            <div class="header-content">
                <h2>Films Recommandés</h2>
                <div class="results-count" id="count-display">Chargement...</div>
            </div>

            <div id="debug-filters">Filtres actifs: Aucun</div>
            <div id="sparql-container"></div>
            <div id="movie-grid" class="movie-grid"></div>
            <div id="empty-state" style="display:none; text-align:center; padding:50px; color:#666;">Aucun film trouvé.
            </div>
        </main>
    </div>

    <script>
        // API
        async function fetchSparql(query) {
            try {
                const res = await fetch('/api/sparql', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query })
                });
                const data = await res.json();
                return data.error ? null : data;
            } catch (e) {
                console.error(e);
                return null;
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Init
        async function initFilters() {
            // Genres
            const gQuery = `
                PREFIX : <http://saraaymericradhi.org/movie-ontology#>
                PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
                SELECT DISTINCT ?genreLabel WHERE {
                    ?movie :hasContent [ :hasGenre [ skos:prefLabel ?genreLabel ] ] .
                } ORDER BY ?genreLabel
            `;
            const genres = await fetchSparql(gQuery);
            const gCont = document.getElementById('genre-container');
            if (genres) {
                genres.forEach(r => {
                    const g = r.genreLabel.value;
                    const div = document.createElement('div');
                    div.className = 'checkbox-label';
                    div.innerHTML = `<label><input type="checkbox" value="${g}" onchange="filterMovies()"> ${g}</label>`;
                    gCont.appendChild(div);
                });
            }

            // Years
            const yQuery = `
                PREFIX : <http://saraaymericradhi.org/movie-ontology#>
                SELECT (MIN(YEAR(?date)) as ?minYear) (MAX(YEAR(?date)) as ?maxYear) WHERE {
                    ?movie :hasInformation [ :hasReleaseDate ?date ] .
                }
            `;
            const yData = await fetchSparql(yQuery);
            let min = 1900, max = new Date().getFullYear();
            if (yData && yData[0] && yData[0].minYear) {
                min = parseInt(yData[0].minYear.value);
                max = parseInt(yData[0].maxYear.value);
            }
            const minSel = document.getElementById('f-year-min');
            const maxSel = document.getElementById('f-year-max');
            for (let i = min; i <= max; i++) {
                minSel.add(new Option(i, i));
                maxSel.add(new Option(i, i));
            }
            minSel.value = min;
            maxSel.value = max;

            filterMovies();
        }

        let currentRequestId = 0;
        const debouncedFilterMovies = debounce(() => filterMovies(), 500);

        async function filterMovies() {
            const grid = document.getElementById('movie-grid');
            const count = document.getElementById('count-display');
            const debug = document.getElementById('debug-filters');

            // INCREMENT REQUEST ID
            const myRequestId = ++currentRequestId;

            grid.style.opacity = '0.5';
            count.textContent = 'Recherche...';

            try {
                // Inputs
                const search = document.getElementById('f-search').value.toLowerCase();
                const minRat = document.getElementById('f-rating').value;
                const dir = document.getElementById('f-director').value.trim();
                const act = document.getElementById('f-actor').value.trim();
                const genreCbs = document.querySelectorAll('#genre-container input:checked');
                const genres = Array.from(genreCbs).map(cb => cb.value);
                const minYear = document.getElementById('f-year-min').value;
                const maxYear = document.getElementById('f-year-max').value;

                debug.textContent = `Filtres actifs: ${genres.length ? genres.join(', ') : 'Aucun genre'} | Note > ${minRat} (Req #${myRequestId})`;

                // --- 1. BUILD INNER QUERY (Filtering) ---
                // We find the TOP 500 matching Movie URIs first.
                // This avoids joining ALL actors/genres/directors for movies we won't show.

                let innerWhere = `  ?movie a :Movie . \n`;

                if (search) {
                    innerWhere += `
  ?movie :hasTitle ?searchTitle . 
  FILTER(CONTAINS(LCASE(?searchTitle), "${search}"))
`;
                }

                if (genres.length > 0) {
                    const genreList = genres.map(g => `"${g.toLowerCase()}"`).join(', ');
                    innerWhere += `
  ?movie :hasContent [ :hasGenre [ skos:prefLabel ?filterGenre ] ] .
  FILTER(LCASE(STR(?filterGenre)) IN (${genreList}))
`;
                }

                if (dir) {
                    innerWhere += `
  ?movie :hasProduction [ :hasCrewMember [ :personName ?filterDir; :job "Director" ] ] .
  FILTER(CONTAINS(LCASE(STR(?filterDir)), "${dir.toLowerCase()}"))
`;
                }

                if (act) {
                    innerWhere += `
  ?movie :hasProduction [ :hasCastMember [ :personName ?filterAct ] ] .
  FILTER(CONTAINS(LCASE(STR(?filterAct)), "${act.toLowerCase()}"))
`;
                }

                if (minYear && maxYear && minYear !== "Min" && maxYear !== "Max") {
                    innerWhere += `
  ?movie :hasInformation [ :hasReleaseDate ?filterDate ] .
  BIND(YEAR(?filterDate) as ?filterYear)
  FILTER(?filterYear >= ${minYear} && ?filterYear <= ${maxYear})
`;
                }

                if (minRat > 0) {
                    innerWhere += `
  ?movie :hasResult [ :hasVoteAverage ?filterRate ] .
  FILTER(?filterRate >= ${minRat})
`;
                }

                // --- 2. BUILD OUTER QUERY (Display) ---
                // We take the fixed 500 movies and fetch their deep details.

                const query = `PREFIX : <http://saraaymericradhi.org/movie-ontology#>
PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>
PREFIX skos: <http://www.w3.org/2004/02/skos/core#>

SELECT DISTINCT ?movie ?title ?year ?duration ?rating 
    (GROUP_CONCAT(DISTINCT COALESCE(?directorName, ""); separator=", ") AS ?directors)
    (GROUP_CONCAT(DISTINCT COALESCE(?genreLabel, ""); separator=", ") AS ?genres)
    (GROUP_CONCAT(DISTINCT COALESCE(?actorName, ""); separator=", ") AS ?cast)
WHERE {
  {
    SELECT DISTINCT ?movie WHERE {
      ${innerWhere}
    } LIMIT 500
  }

  # --- Fetch Display Data ---
  OPTIONAL { ?movie :hasTitle ?titleTmp } BIND(COALESCE(?titleTmp, "Sans Titre") AS ?title)
  
  OPTIONAL { 
      ?movie :hasInformation ?info .
      OPTIONAL { ?info :hasReleaseDate ?date . BIND(YEAR(?date) as ?year) }
      OPTIONAL { ?info :hasRuntime ?duration }
  }
  OPTIONAL { ?movie :hasResult [ :hasVoteAverage ?rating ] }

  # Aggregates (Optimized: only runs for the 500 selected movies)
  OPTIONAL { ?movie :hasProduction [ :hasCrewMember [ :personName ?directorName; :job "Director" ] ] }
  OPTIONAL { ?movie :hasContent [ :hasGenre [ skos:prefLabel ?genreLabel ] ] }
  OPTIONAL { ?movie :hasProduction [ :hasCastMember [ :personName ?actorName ] ] }

} GROUP BY ?movie ?title ?year ?duration ?rating`;

                document.getElementById('sparql-container').textContent = query;
                console.log(`SPARQL [${myRequestId}]:`, query);

                const res = await fetchSparql(query);

                // RACE CONDITION CHECK
                if (myRequestId !== currentRequestId) {
                    console.warn(`Ignoring result for Request ID ${myRequestId} (Current: ${currentRequestId})`);
                    return;
                }

                grid.style.opacity = '1';

                if (res) renderMovies(res);
                else {
                    count.textContent = "Erreur";
                    grid.innerHTML = "Erreur SPARQL";
                }
            } catch (e) {
                console.error("Filter Error:", e);
                count.textContent = "Erreur JS";
            }
        }

        function renderMovies(rows) {
            const grid = document.getElementById('movie-grid');
            const count = document.getElementById('count-display');
            document.getElementById('empty-state').style.display = (rows && rows.length) ? 'none' : 'block';
            count.textContent = `${rows ? rows.length : 0} films`;
            grid.innerHTML = '';

            if (!rows) return;

            rows.forEach(r => {
                const m = {
                    title: r.title?.value || "Sans titre",
                    year: r.year?.value || "-",
                    dur: parseInt(r.duration?.value || 0),
                    rate: parseFloat(r.rating?.value || 0).toFixed(1),
                    dir: r.directors?.value || "", // Use empty string if missing
                    genres: r.genres?.value ? r.genres.value.split(', ') : [],
                    cast: r.cast?.value ? r.cast.value.split(', ') : [],
                    color: stringToColor(r.title?.value || "")
                };

                const dirDisplay = m.dir ? m.dir : "Inconnu";

                const card = document.createElement('div');
                card.className = 'movie-card';
                card.innerHTML = `
                    <div class="card-image" style="background:${m.color}"><i class="fas fa-film"></i><div class="card-rating">${m.rate}</div></div>
                    <div class="card-content">
                        <div class="card-title">${m.title}</div>
                        <div class="card-meta"><span>${m.year}</span><span>${Math.floor(m.dur / 60)}h ${m.dur % 60}</span></div>
                        <div class="card-genres">${m.genres.slice(0, 3).map(g => `<span class="genre-pill">${g}</span>`).join('')}</div>
                        <div class="card-people"><div>Dir: ${dirDisplay}</div></div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function stringToColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) { hash = str.charCodeAt(i) + ((hash << 5) - hash); }
            const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
            return '#' + "00000".substring(0, 6 - c.length) + c;
        }

        function updateRatingDisplay(v) { document.getElementById('rating-val').textContent = v + '+'; }

        function resetFilters() {
            document.getElementById('f-search').value = '';
            document.getElementById('f-rating').value = 0;
            updateRatingDisplay(0);
            document.querySelectorAll('#genre-container input').forEach(cb => cb.checked = false);

            // Text inputs
            document.getElementById('f-director').value = '';
            document.getElementById('f-actor').value = '';

            // Reset Years to full range
            const minSel = document.getElementById('f-year-min');
            if (minSel.options.length > 0) minSel.selectedIndex = 0; // First option is usually Min

            const maxSel = document.getElementById('f-year-max');
            if (maxSel.options.length > 0) maxSel.selectedIndex = maxSel.options.length - 1; // Last option is Max

            filterMovies();
        }
        function toggleSparql() {
            const el = document.getElementById('sparql-container');
            // If display is '' (CSS default) or 'none', show it.
            el.style.display = (el.style.display === 'block') ? 'none' : 'block';
        }

        window.onload = initFilters;
    </script>
</body>

</html>